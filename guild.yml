######################
#     OPERATIONS     #
######################
- config: high-level-flags
  flags:
    method:
      required: yes
      type: string
    experiment-name:
      required: no
      arg-skip: yes  #  don't include as arg, log to guild
      type: string
    fully-observed:
      required: no
    feature-map:
      required: no
      type: string 
    percent-missing:
      required: no
      type: float
    amputation-patterns:
      required: no
    replace-nan-with:
      required: no
      type: string

# what to do when you run `guild run`
- operations:
    main:
      description: Train and evaluate an imputer, run downstream predictions.
      flags-import: no
      label: ${method} ${experiment-name}
      # plugins: summary
      env: # don't save pycache
        PYTHONDONTWRITEBYTECODE: 1
      sourcecode:
        - include:
          - '*.py'
          - '*.json'
          - '*.yml'
        - exclude:
            dir:
              - mlruns
              - notebooks
              - tune_results
      output-scalars: off
      requires:
        config: options.yml
      flags:
        $include:
          - high-level-flags
      steps:
        - run: train_predict method=${method} experiment-name=${experiment-name} fully-observed=${fully-observed} feature-map=${feature-map} percent-missing=${percent-missing} amputation-patterns=${amputation-patterns} replace-nan-with=${replace-nan-with}
        - run: test method=${method} experiment-name=${experiment-name} fully-observed=${fully-observed} feature-map=${feature-map} percent-missing=${percent-missing} amputation-patterns=${amputation-patterns} replace-nan-with=${replace-nan-with}

    train_predict:
      description: Train an imputer and run predictions.
      label: ${method} ${experiment-name}
      main: autopopulus/main
      env: # don't save pycache
        PYTHONDONTWRITEBYTECODE: 1
      sourcecode:
        - include:
          - '*.py'
          - '*.json'
          - '*.yml'
        - exclude:
            dir:
              - mlruns
              - notebooks
              - tune_results
      output-scalars: off
      requires:
        - config: options.yml
      flags:
        $include:
          - high-level-flags

    test:
      description: Evaluate/test an imputer if it's an autoencoder.
      label: ${method} ${experiment-name}
      main: autopopulus/evaluate_imputer
      env: # don't save pycache
        PYTHONDONTWRITEBYTECODE: 1
      sourcecode:
        - include:
          - '*.py'
          - '*.json'
          - '*.yml'
        - exclude:
            dir:
              - mlruns
              - notebooks
              - tune_results
      output-scalars: off
      requires:
        - config: options.yml
        - operation: train_predict  # require files generated by train_predict
      flags:
        $include:
          - high-level-flags
    